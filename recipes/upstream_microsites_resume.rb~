#
# Cookbook Name:: tgtapps
# Recipe:: default
#
# Copyright 2011, YOUR_COMPANY_NAME
#
# All rights reserved - Do Not Redistribute
#

gems = %w{ bundler }
appname = 'microsites2_resume'

gems.each do |gem|
  gem_package gem do
    action :install
  end
end

app = data_bag_item("apps", 'opcoes')

template "/srv/#{appname}/shared/unicorn.rb" do
  owner 'ubuntu'
  group 'nogroup'
  source "unicorn.conf.rb.erb"
  mode "0664"
  variables(
    :app => app['id'],
    :port => app['unicorn_port']
  )
end 

upstart_script_name = "#{app['id']}-app"

template "/etc/init/#{upstart_script_name}.conf" do
  source "unicorn-upstart.conf.erb"
  owner "root"
  group "root"
  mode "0664"

  variables(
    :app_name       => app['id'],
    :app_root       => "/srv/#{appname}/current",
    :log_file       => "/srv/#{appname}/current/log/unicorn.log",
    :unicorn_config => "/srv/#{appname}/shared/unicorn.rb",
    :unicorn_binary => "bundle exec unicorn_rails",
    :rack_env       => 'production'
  )
end

service upstart_script_name do
  provider Chef::Provider::Service::Upstart
  supports :status => true, :restart => true
  action [ :enable, :start ]
end
    
    
